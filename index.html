<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英語学習フラッシュカード</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* コンテンツを上部に配置 */
            min-height: 100vh; /* 画面の高さいっぱいに表示 */
            height: 100%; /* スクロールバー対策 */
            background: #000; /* フォールバック背景色 */
            color: white;
            overflow-x: hidden; /* 横スクロールバーを防止 */
            position: relative; /* 背景要素の基準点 */
            box-sizing: border-box; /* paddingを含めて計算 */
        }

        /* 銀河背景のアニメーション */
        body:before {
            content: "";
            position: fixed; /* 背景を固定 */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(125deg, #090e29, #020024, #1e0a3d, #09244c);
            background-size: 400% 400%; /* アニメーションのために拡大 */
            z-index: -2; /* コンテンツの下に配置 */
            animation: galaxyMove 20s ease infinite; /* アニメーション */
        }

        /* 星のきらめき効果 */
        .stars {
            position: fixed; /* 星を固定 */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* クリックイベントを無効化 */
            z-index: -1; /* 背景とコンテンツの間に配置 */
        }

        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            /* アニメーションのプロパティをCSS変数で設定 */
            animation: twinkle var(--duration) ease-in-out infinite;
            opacity: var(--opacity); /* 初期透明度 */
        }

        @keyframes galaxyMove {
            0% { background-position: 0% 50% }
            50% { background-position: 100% 50% }
            100% { background-position: 0% 50% }
        }

        /* 修正: より安定した星の瞬きアニメーション */
        @keyframes twinkle {
            0%, 100% {
                /* 開始/終了時は基本の透明度 */
                opacity: var(--opacity);
                transform: scale(1);
            }
            20% {
                /* 少し暗く、小さく (元の60%) */
                opacity: calc(var(--opacity) * 0.6);
                transform: scale(0.9);
            }
            50% {
                /* やや明るく、大きく (元の95%) */
                 opacity: calc(var(--opacity) * 0.95);
                 transform: scale(1.05);
            }
             80% {
                 /* 再び暗く (元の50%) */
                 opacity: calc(var(--opacity) * 0.5);
                 transform: scale(0.95);
             }
        }


        h1 {
            font-weight: 600;
            margin: 10px 0 5px; /* 上下のマージン調整 */
            color: #ffffff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7), 0 0 20px rgba(255, 255, 255, 0.5);
            font-size: 2.2rem;
            letter-spacing: 1px;
        }

        /* カテゴリ選択グリッドのスタイル */
        .category-grid {
             display: grid;
             grid-template-columns: repeat(2, 1fr);
             grid-gap: 15px;
             max-width: 600px;
             width: 90%; /* 幅を確保 */
             margin: 15px auto 20px auto; /* 上下マージン調整 */
        }

        /* カテゴリカードの共通スタイル */
        .category-card {
            background: linear-gradient(135deg, rgba(36, 123, 205, 0.3), rgba(16, 54, 140, 0.2));
            padding: 15px;
            border-radius: 12px;
            cursor: pointer;
            text-align: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1); /* デフォルトボーダー */
            transition: all 0.3s ease;
        }

        .category-card h3 {
            margin: 0 0 5px 0;
            font-size: 1.1rem;
            color: white;
            font-weight: 500; /* 少し太く */
        }

        .category-card p {
            margin: 0;
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 300; /* pタグは細めに */
            text-shadow: none; /* pタグの影は削除 */
        }

        /* 選択中のカテゴリカード */
        .category-card.active {
             border: 2px solid rgba(52, 152, 219, 0.6); /* 強調ボーダー */
             box-shadow: 0 0 10px rgba(52, 152, 219, 0.3); /* 軽い光彩 */
        }

        /* .control-panel は .control-container 内の要素としてスタイル */

        .card-container {
            width: 90%; /* 幅を画面比率で設定 */
            max-width: 400px; /* 最大幅を設定 */
            height: 250px; /* カードの高さを設定 */
            perspective: 1500px; /* 3D効果の奥行き */
            margin: 10px auto 20px auto; /* 上下マージン調整 (上を詰める) */
            position: relative;
            z-index: 1; /* コントロールパネルより奥 */
        }

        .card {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d; /* 3D空間で子要素を配置 */
            transition: transform 0.5s ease; /* 回転アニメーション（より直線的に） */
            cursor: default; /* 通常はクリック不可 */
        }

        .card.clickable {
            cursor: pointer; /* 一時停止中はクリック可能 */
        }

        .card.flipped {
            transform: rotateY(180deg); /* Y軸を中心に180度回転 */
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden; /* Safari用裏面非表示 */
            backface-visibility: hidden; /* 裏面を非表示 */
            padding: 20px; /* 内側の余白 */
            box-sizing: border-box; /* paddingを含めて計算 */
            border-radius: 16px; /* 角を丸める */
            background: rgba(255, 255, 255, 0.1); /* 半透明の背景 */
            backdrop-filter: blur(10px); /* 背景をぼかす（すりガラス効果） */
            -webkit-backdrop-filter: blur(10px); /* Safari用 */
            border: 1px solid rgba(255, 255, 255, 0.2); /* 枠線 */
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3); /* 影 */
            overflow: hidden; /* 内容がはみ出ないように */
        }

        .card-front {
            background: linear-gradient(135deg, rgba(36, 123, 205, 0.5), rgba(16, 54, 140, 0.3)); /* 青系のグラデーション */
            color: white;
            /* 表面は中央揃えのため flex を維持 */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .card-back {
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.5), rgba(20, 90, 50, 0.3)); /* 緑系のグラデーション */
            color: white;
            transform: rotateY(180deg); /* 最初から裏返しておく */
            display: none; /* 初期状態は非表示 */
            position: relative; /* 子要素の absolute 配置の基準 */
        }

        /* カード内のh2 (単語表示) */
        .card h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 2rem; /* 単語のフォントサイズ */
            font-weight: 600;
            letter-spacing: 1px;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
            /* グラデーションテキスト */
            background: linear-gradient(to right, #ffffff, #d1d1d1);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        /* ページタイトル下のh2 (フラッシュカード) */
         body > h2 {
            margin-top:0;
            text-shadow:0 0 5px rgba(255,255,255,0.5);
            font-size:1.2rem;
            font-weight:400;
            margin-bottom:0px; /* カテゴリグリッド/カードカウンターとのマージンを詰める */
            line-height:1.5;
            text-align:center;
            background: none; /* グラデーション解除 */
             -webkit-background-clip: unset;
             background-clip: unset;
             -webkit-text-fill-color: unset;
             color: white; /* 色を白に戻す */
        }


        p { /* 汎用スタイル */
            margin: 5px 0;
            font-size: 18px;
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            font-weight: 300; /* 少し細めのフォント */
        }

        /* カード裏面のpタグのスタイル調整 (CSSでは基本配置のみ) */
        .card-back p {
             position: absolute;
             left: 50%;
             width: 90%;
             text-align: center;
             margin: 0;
             /* transform はJS側で設定 */
        }
        /* 裏面テキストの個別スタイル */
        .card-back p.definition-jp {
            font-size: 1.3rem;
            color: #FFD700;
            font-weight: 500;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
        }
        .card-back p.definition-en {
             font-size: 0.95rem;
             color: white;
             font-weight: 400;
             line-height: 1.4;
             text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
        }


        .definition {
            /* スタイルはインラインで指定 */
        }

        .button {
            padding: 12px 24px;
            color: white;
            border: none;
            border-radius: 30px; /* 丸みを帯びたボタン */
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            letter-spacing: 0.5px;
            position: relative; /* :before要素の基準 */
            overflow: hidden; /* :before要素がはみ出ないように */
            transition: all 0.3s ease; /* ホバー効果のトランジション */
            backdrop-filter: blur(5px); /* ボタンの背景ぼかし */
            -webkit-backdrop-filter: blur(5px);
            background: rgba(255, 255, 255, 0.15); /* 半透明背景 */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); /* 影 */
        }

        /* ボタンのホバー時の光沢エフェクト */
        .button:before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: 0.5s;
        }

        .button:hover:before {
            left: 100%;
        }

        .start-button {
            background: linear-gradient(45deg, rgba(52, 152, 219, 0.8), rgba(41, 128, 185, 0.8)); /* 青系グラデーション */
            border: 1px solid rgba(255, 255, 255, 0.2);
            margin-top: 15px; /* カテゴリグリッドとのマージン */
        }

        .start-button:hover {
            background: linear-gradient(45deg, rgba(52, 152, 219, 0.9), rgba(41, 128, 185, 0.9));
            box-shadow: 0 0 20px rgba(52, 152, 219, 0.5); /* ホバー時の光彩効果 */
            transform: translateY(-2px); /* 少し上に移動 */
        }

        /* コントロール内のボタン共通スタイル */
        .control-button {
             color: white;
             border: none;
             border-radius: 20px;
             cursor: pointer;
             transition: all 0.3s ease;
             padding: 6px 12px; /* パディング調整 */
             font-size: 12px;
             text-align: center;
             min-width: 60px; /* 最小幅設定 */
             /* ★ ボタンが均等に広がるように */
             flex-grow: 1;
             flex-basis: 0;
        }

        .prev-button { /* 戻るボタン */
             background: linear-gradient(45deg, #6c757d, #495057); /* グレー系 */
        }
        .prev-button:hover {
             background: linear-gradient(45deg, #868e96, #5a6268);
             transform: translateY(-1px);
             box-shadow: 0 2px 8px rgba(108, 117, 125, 0.4);
        }

        .next-button { /* 小さい方の次へボタン */
            background: linear-gradient(45deg, rgb(39, 174, 96), rgb(27, 120, 66));
        }

        .next-button:hover {
             background: linear-gradient(45deg, rgb(46, 204, 113), rgb(39, 174, 96)); /* ホバー色調整 */
             transform: translateY(-1px);
             box-shadow: 0 2px 8px rgba(46, 204, 113, 0.4);
        }

        .pause-button { /* 小さい方の停止ボタン */
            background: linear-gradient(45deg, rgb(211, 84, 0), rgb(170, 67, 0));
        }

        .pause-button:hover {
            background: linear-gradient(45deg, rgb(243, 156, 18), rgb(211, 84, 0)); /* ホバー色調整 */
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(243, 156, 18, 0.4);
        }
         /* 再生ボタンのスタイル */
         .pause-button.resume {
             background: linear-gradient(45deg, rgb(142, 68, 173), rgb(91, 44, 111));
         }
         .pause-button.resume:hover {
             background: linear-gradient(45deg, rgb(155, 89, 182), rgb(142, 68, 173));
             box-shadow: 0 2px 8px rgba(155, 89, 182, 0.4);
         }


        .progress {
            margin-top: 20px;
            width: 100%;
            text-align: center;
        }

        .hidden {
            display: none !important; /* 確実に非表示にする */
        }

        /* カードカウンターのスタイル調整 */
        .card-counter {
            font-size: 18px;
            margin-top: 10px; /* 上（タイトル）とのマージン */
            margin-bottom: 10px; /* 下（カード）とのマージン */
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
            background: rgba(0, 0, 0, 0.2); /* 半透明背景 */
            padding: 5px 15px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: none; /* 初期状態は非表示、JSで表示 */
            width: fit-content;
            text-align: center;
            align-self: center; /* 中央揃え */
            font-family: 'Roboto Mono', monospace;
        }

        /* コントロール要素のコンテナ */
        .control-container {
             display: flex;
             gap: 15px;
             justify-content: center;
             flex-wrap: wrap; /* 幅が足りなければ折り返す */
             margin-top: 15px; /* カードとの間隔 */
             width: 100%;
             max-width: 500px; /* 最大幅 */
        }

        /* 各コントロールパネル（共通） */
        .control-panel {
            text-align: center;
            padding: 10px 15px;
            background: rgba(13, 16, 33, 0.7);
            border-radius: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(55, 75, 110, 0.4);
            /* width: auto; */ /* width指定を削除 */
            display: none; /* 初期状態は非表示、JSで表示 */
            flex-direction: column; /* ラベルとボタンを縦に */
            align-items: center; /* 中央揃え */
            /* ★ パネルが均等に広がるように */
            flex-grow: 1;
            flex-basis: 0; /* flex-growと合わせて使う */
            min-width: 150px; /* 最小幅を設定して極端に狭くなるのを防ぐ */
        }
        .control-panel .panel-label {
            color: white;
            font-size: 14px;
            margin-bottom: 8px;
            font-weight: 500;
            text-align: center;
            width: 100%;
        }
        .control-panel .panel-buttons {
            display: flex;
            justify-content: center; /* 中央揃えに変更 */
            gap: 8px; /* ボタン間のギャップ調整 */
            width: 100%;
        }

        /* 操作ボタンパネル内のボタン */
        #controlBox .panel-buttons button {
             /* 基本スタイルは .control-button で指定 */
        }

        /* 速度ボタン */
        .speed-button {
            background: rgba(86, 101, 115, 0.6);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
             /* ★ 共通スタイルを継承 */
             padding: 6px 12px;
             font-size: 12px;
             text-align: center;
             min-width: 60px;
             flex-grow: 1;
             flex-basis: 0;
        }

        .speed-button:hover {
            background: rgba(128, 140, 141, 0.7);
            transform: translateY(-1px);
        }

        .speed-button.active {
            background: linear-gradient(45deg, rgb(41, 128, 185), rgb(33, 97, 140));
            font-weight: 500;
            box-shadow: 0 0 10px rgba(41, 128, 185, 0.5);
        }

        /* 選択中カテゴリ表示 */
        .category-info {
            margin-top: 20px; /* スタートボタンとのマージン */
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
            font-size: 0.9rem;
        }

        /* トップへ戻るボタン */
        .back-button-container {
            margin-top: 20px;
            text-align: center;
        }
        .back-button {
            padding: 8px 20px;
            background: linear-gradient(45deg, rgba(52, 73, 94, 0.8), rgba(44, 62, 80, 0.8));
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            display: none; /* 初期状態は非表示 */
        }
         .back-button:hover {
             background: linear-gradient(45deg, rgba(72, 93, 114, 0.9), rgba(64, 82, 100, 0.9));
             transform: translateY(-1px);
             box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
         }


        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            body {
                padding: 10px;
                min-height: 100vh;
                justify-content: flex-start;
            }

            h1 {
                font-size: 2rem;
                margin-top: 10px;
                margin-bottom: 0;
            }

            body > h2 {
                font-size: 1.1rem;
                margin-bottom: 10px;
            }

            .category-grid {
                grid-gap: 10px;
                margin-top: 10px;
                margin-bottom: 15px;
            }
            .category-card {
                padding: 12px;
                border-radius: 10px;
            }
             .category-card h3 { font-size: 1rem; }
             .category-card p { font-size: 0.8rem; }

             .card-counter {
                 margin-top: 8px;
                 margin-bottom: 8px;
                 font-size: 16px;
                 padding: 4px 12px;
             }

            .card-container {
                width: 90%;
                height: 252px;
                margin: 8px auto 15px auto;
            }

             .card-back {
                 padding: 15px;
             }
             /* ★裏面のpタグ位置調整 (Tablet) - JS側で設定 */
              .card-back p.definition-jp {
                 font-size: 1.2rem; /* Tabletでのフォントサイズ調整 */
             }
             .card-back p.definition-en {
                 font-size: 0.9rem; /* Tabletでのフォントサイズ調整 */
                 bottom: 20px; /* Tabletでの下部マージン調整 */
             }


            .card h2 {
                font-size: 1.7rem;
                margin-bottom: 10px;
            }

            p { /* カード内のテキストサイズ (汎用) */
                font-size: 15px;
            }

            .button {
                padding: 10px 20px;
                font-size: 15px;
            }
             .start-button {
                 margin-top: 15px;
             }

             .control-container {
                 gap: 10px;
                 margin-top: 10px;
             }
             .control-panel {
                 padding: 8px 12px;
                 /* min-width: auto; */ /* レスポンシブでは最小幅をリセット */
                 min-width: 0; /* flex-basis:0 と合わせて */
             }
             .control-panel .panel-label { font-size: 13px; }

             /* ★ レスポンシブでのボタンサイズ調整は削除（基本スタイルでflex-growするため） */
             /* #controlBox .panel-buttons button,
             #speedControl .panel-buttons button {
                 padding: 8px 15px;
                 font-size: 1rem;
                 flex-grow: 1;
                 flex-basis: 0;
             } */


            .category-info {
                margin-top: 15px;
                font-size: 0.85rem;
            }
            .back-button-container { margin-top: 15px; }
            .back-button { font-size: 13px; padding: 7px 18px; }
        }

        @media (max-width: 480px) {
             body {
                padding: 8px;
            }

            h1 {
                font-size: 1.8rem;
                margin-top: 5px;
            }
             body > h2 {
                font-size: 1rem;
                margin-bottom: 8px;
            }

             .category-grid {
                grid-gap: 8px;
                margin-top: 8px;
                margin-bottom: 12px;
                width: 95%;
            }
            .category-card {
                padding: 10px;
                border-radius: 8px;
            }
             .category-card h3 { font-size: 0.9rem; }
             .category-card p { font-size: 0.75rem; }

             .card-counter {
                 margin-top: 5px;
                 margin-bottom: 5px;
                 font-size: 14px;
                 padding: 4px 12px;
             }

            .card-container {
                width: 95%;
                height: 210px;
                margin: 5px auto 10px auto;
            }

             .card-back {
                 padding: 10px;
             }

            .card h2 {
                font-size: 1.5rem;
            }

             .card-front p, .card-back p {
                 /* font-size: 13px; */ /* CSSでクラス指定 */
                 /* margin: 3px 0; */ /* CSSでクラス指定 */
             }

             /* ★裏面のpタグ位置調整 (Mobile) - JS側で設定 */
             .card-back p.definition-jp {
                 font-size: 1.1rem; /* Mobileでのフォントサイズ調整 */
             }
             .card-back p.definition-en {
                 font-size: 0.85rem; /* Mobileでのフォントサイズ調整 */
                 bottom: 15px; /* Mobileでの下部マージン調整 */
             }


            .button {
                padding: 8px 16px;
                font-size: 14px;
            }
             .start-button {
                 margin-top: 12px;
             }

             .control-container {
                 gap: 8px;
                 margin-top: 8px;
             }
             .control-panel {
                 padding: 6px 10px;
                 /* min-width: auto; */ /* レスポンシブでは最小幅をリセット */
                 min-width: 0; /* flex-basis:0 と合わせて */
             }
              .control-panel .panel-label { font-size: 12px; margin-bottom: 5px; }
              #controlBox .panel-buttons { gap: 8px; }
              #speedControl .panel-buttons { gap: 5px; }

              /* ★ レスポンシブでのボタンサイズ調整は削除（基本スタイルでflex-growするため） */
              /* #controlBox .panel-buttons button,
              #speedControl .panel-buttons button {
                  padding: 6px 12px;
                  font-size: 15px;
                  flex-grow: 1;
                  flex-basis: 0;
              } */


            .category-info {
                margin-top: 12px;
                font-size: 0.8rem;
            }
             .back-button-container { margin-top: 12px; }
             .back-button { font-size: 12px; padding: 6px 15px; }
        }
    </style>
</head>
<body>
    <div class="stars" id="starsContainer"></div>

    <h1>EIGOASOBI</h1>
    <h2>フラッシュカード</h2>

    <div class="card-counter" id="cardCounter"></div>

    <div class="category-grid">
        <div class="category-card active" id="category-awl1">
            <h3>AWL 570</h3>
            <p>Rank 1 - 100</p>
        </div>
         <div class="category-card" id="category-awl2">
            <h3>AWL 570</h3>
            <p>Rank 101 - 200</p>
        </div>
        <div class="category-card" id="category-awl3">
            <h3>AWL 570</h3>
            <p>Rank 201 - 300</p>
        </div>
         <div class="category-card" id="category-awl4">
            <h3>AWL 570</h3>
            <p>Rank 301 - 400</p>
        </div>
         <div class="category-card" id="category-awl5">
            <h3>AWL 570</h3>
            <p>Rank 401 - 500</p>
        </div>
         <div class="category-card" id="category-awl6">
            <h3>AWL 570</h3>
            <p>Rank 501 - 570</p>
        </div>
    </div>

    <div class="card-container hidden" id="cardContainer">
        <div class="card" id="currentCard">
            <div class="card-front" id="cardFront">
                </div>
            <div class="card-back" id="cardBack">
                </div>
        </div>
    </div>

    <div class="control-container">
        <div class="control-panel" id="controlBox">
            <div class="panel-label">コントロール</div>
            <div class="panel-buttons">
                 <button class="control-button pause-button" id="pauseButtonSmall">停止</button>
                <button class="control-button prev-button" id="prevButtonSmall">戻る</button>
                <button class="control-button next-button" id="nextButtonSmall">次へ</button>
            </div>
        </div>

        <div class="control-panel" id="speedControl">
            <div class="panel-label">表示速度</div>
            <div class="panel-buttons">
                <button class="speed-button active" id="speed2s">２秒</button>
                <button class="speed-button" id="speed1s">１秒</button>
                <button class="speed-button" id="speed0_5s">０.５秒</button>
            </div>
        </div>
    </div>

    <button class="button start-button" id="startButton">スタート</button>

    <div class="category-info" id="categoryInfo">
        選択中: <span id="selectedCategoryText">AWL 570</span>
    </div>

    <div class="back-button-container">
        <button class="back-button" id="backButton">トップ画面に戻る</button>
    </div>

    <script>
        // 星空エフェクトを生成する関数
        function createStars() {
            const starsContainer = document.getElementById('starsContainer');
            if (!starsContainer) return; // 要素チェック追加
            // パフォーマンスに応じて星の数を調整
            const isMobile = window.innerWidth <= 768 || 'ontouchstart' in window;
            let starsCount;

            // 画面サイズに基づいて適切な星の数を設定
            if (isMobile) {
                starsCount = window.innerWidth < 480 ? 50 : 80; // 小さい画面では50、それ以上では80
            } else {
                starsCount = 150; // デスクトップ
            }

            // 既存の星をクリア
            starsContainer.innerHTML = '';

            for (let i = 0; i < starsCount; i++) {
                const star = document.createElement('div');
                star.classList.add('star');

                // ランダムな位置とサイズ（モバイルでは小さめのサイズに）
                const size = isMobile ? Math.random() * 1.5 + 0.5 : Math.random() * 2 + 1; // サイズ範囲調整
                const left = Math.random() * 100;
                const top = Math.random() * 100;
                // アニメーション時間も多様に
                const duration = isMobile ? 3 + Math.random() * 5 : 4 + Math.random() * 8; // 少し長めに
                const delay = Math.random() * 5; // 遅延も多様に
                // 初期透明度もランダムに (0.3から1.0の間)
                const opacity = 0.3 + Math.random() * 0.7;

                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.left = `${left}%`;
                star.style.top = `${top}%`;
                // CSS変数を設定
                star.style.setProperty('--duration', `${duration}s`);
                star.style.setProperty('--opacity', opacity);
                star.style.animationDelay = `${delay}s`;

                starsContainer.appendChild(star);
            }
        }


        // ページロード時に星空を生成
        window.addEventListener('load', createStars);
        // ウィンドウサイズ変更時に星空を再生成（負荷軽減のためdebounceなど考慮するのも良い）
        let resizeTimer;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(() => {
                 const starsContainer = document.getElementById('starsContainer');
                 if (starsContainer) { // 要素が存在するか確認
                    starsContainer.innerHTML = ''; // 一旦クリア
                    createStars(); // 再生成
                 }
            }, 250); // 250ms待ってから再生成
        });

        // カードデータ (AWL Rank 1-100) - ★英語定義を更新
        const cards = [
             { front: { word: "repertoire" }, back: { pronunciation: "ˈrɛp.ərˌtwɑr", definition_jp: "スキルや技能の集合", definition_en: "スキルや業績のコレクション" } },
             { front: { word: "obtain" }, back: { pronunciation: "əbˈteɪn", definition_jp: "手に入れる", definition_en: "得る" } },
             { front: { word: "distribution" }, back: { pronunciation: "ˌdɪs.trəˈbju.ʃən", definition_jp: "分布", definition_en: "物事が特定の地域やグループに広がっている方法" } },
             { front: { word: "parameter" }, back: { pronunciation: "pəˈræm.ɪ.tər", definition_jp: "パラメータ", definition_en: "特性や一定の要素、限界" } },
             { front: { word: "aspect" }, back: { pronunciation: "ˈæs.pɛkt", definition_jp: "側面", definition_en: "特質、部分、または要素" } },
             { front: { word: "dynamic" }, back: { pronunciation: "daɪˈnæ.mɪk", definition_jp: "動的な", definition_en: "常に活動している、または変化している；物理学では：運動に関連する力" } },
             { front: { word: "impact" }, back: { pronunciation: "ˈɪm.pækt", definition_jp: "影響", definition_en: "衝撃的な効果や結果（動詞）力強く打つ" } },
             { front: { word: "domain" }, back: { pronunciation: "doʊˈmeɪn", definition_jp: "領域", definition_en: "行動、思考、または影響の分野；知識の領域" } },
             { front: { word:"publish" }, back: { pronunciation: "ˈpʌb.lɪʃ", definition_jp: "出版する", definition_en: "本、雑誌、またはオンラインで印刷する" } },
             { front: { word: "denote" }, back: { pronunciation: "dɪˈnoʊt", definition_jp: "示す", definition_en: "何かの名前や記号になる" } },
             { front: { word: "authority" }, back: { pronunciation: "əˈθɔr.ɪ.ti", definition_jp: "権威", definition_en: "権力を持つ人々；ほとんどの人に受け入れられている専門家の見解" } },
             { front: { word: "semantic" }, back: { pronunciation: "sɪˈmæn.tɪk", definition_jp: "意味論的な", definition_en: "言葉の異なる意味" } },
             { front: { word: "par" }, back: { pronunciation: "pɑr", definition_jp: "同等", definition_en: "通常の量" } },
             { front: { word: "ion" }, back: { pronunciation: "ˈaɪ.ɒn", definition_jp: "イオン", definition_en: "帯電した原子" } },
             { front: { word: "matrix" }, back: { pronunciation: "ˈmeɪ.trɪks", definition_jp: "母体、行列", definition_en: "物質、状況、または環境で、何かがその起源を持つ場所 - 数学では：行と列の数字の配置" } },
             { front: { word: "linear" }, back: { pronunciation: "ˈlɪn.i.ər", definition_jp: "線形の", definition_en: "線で構成された" } },
             { front: { word: "cognitive" }, back: { pronunciation: "ˈkɒg.nɪ.tɪv", definition_jp: "認知的な", definition_en: "知識を得て記憶するプロセス" } },
             { front: { word: "graph" }, back: { pronunciation: "græf,.grɑf", definition_jp: "グラフ", definition_en: "変数間の関係を示す図表" } },
             { front: { word: "correlation" }, back: { pronunciation: "ˌkɔr.əˈleɪ.ʃən", definition_jp: "相関", definition_en: "2つの変数間の関係の尺度" } },
             { front: { word: "linguistic" }, back: { pronunciation: "lɪŋˈgwɪs.tɪk", definition_jp: "言語の", definition_en: "言語に属する" } },
             { front: { word: "acid" }, back: { pronunciation: "ˈæs.ɪd", definition_jp: "酸", definition_en: "酸味があり、金属や炭酸塩と反応し、青色リトマス紙を赤く変える物質。例：レモン汁" } },
             { front: { word: "induce" }, back: { pronunciation: "ɪn.djus", definition_jp: "誘発する", definition_en: "引き起こす、説得する" } },
             { front: { word: "velocity" }, back: { pronunciation: "vəˈlɒs.ɪ.ti", definition_jp: "速度", definition_en: "特定の方向への速度" } },
             { front: { word: "interval" }, back: { pronunciation: "ˈɪn.tər.vəl", definition_jp: "間隔", definition_en: "2点、数字、または時間の間の距離" } },
             { front: { word: "discourse" }, back: { pronunciation: "ˈdɪs.kɔrs", definition_jp: "談話", definition_en: "会話、対話" } },
             { front: { word: "finite" }, back: { pronunciation: "ˈfaɪ.naɪt", definition_jp: "有限の", definition_en: "限界がある；限られた時間続く" } },
             { front: { word: "stimulus" }, back: { pronunciation: "stɪmyələs", definition_jp: "刺激", definition_en: "変化を起こすもの" } },
             { front: { word: "vector" }, back: { pronunciation: "ˈvɛk.tər", definition_jp: "ベクトル", definition_en: "大きさと方向の両方を持つ量" } },
             { front: { word: "electron" }, back: { pronunciation: "ɪˈlɛk.trɒn", definition_jp: "電子", definition_en: "負に帯電した粒子" } },
             { front: { word: "receptor" }, back: { pronunciation: "rɪˈsɛp.tər", definition_jp: "受容体", definition_en: "情報を受け取る装置" } },
             { front: { word: "theorem" }, back: { pronunciation: "ˈθɪər.əm", definition_jp: "定理", definition_en: "証明できる声明" } },
             { front: { word: "algorithm" }, back: { pronunciation: "ˈæl.gəˌrɪð.əm", definition_jp: "アルゴリズム", definition_en: "問題解決を保証する論理的なルールや手順" } },
             { front: { word: "fluid" }, back: { pronunciation: "ˈflu.ɪd", definition_jp: "流体", definition_en: "簡単に流れることができる物質。例：水" } },
             { front: { word: "developmental" }, back: { pronunciation: "dɪˈvɛl.əp.mənt", definition_jp: "発達の", definition_en: "物事や人の発展や成長に関する" } },
             { front: { word: "bound" }, back: { pronunciation: "baʊnd", definition_jp: "縛られた、跳ぶ", definition_en: "特定の場所に行く；ジャンプする" } },
             { front: { word: "molecular" }, back: { pronunciation: "məˈlɛk.jə.lər", definition_jp: "分子の", definition_en: "結合された原子に関するまたは原子によって引き起こされる" } },
             { front: { word: "transformation" }, back: { pronunciation: "ˌtræns.fərˈmeɪ.ʃən", definition_jp: "変換", definition_en: "変化" } },
             { front: { word: "spatial" }, back: { pronunciation: "ˈspeɪ.ʃəl", definition_jp: "空間の", definition_en: "空間に関する" } },
             { front: { word: "coefficient" }, back: { pronunciation: "ˌkoʊ.əˈfɪʃ.ənt", definition_jp: "係数", definition_en: "数学的表現における変数に掛けられる数字" } },
             { front: { word: "translation" }, back: { pronunciation: "trænzleɪʃən", definition_jp: "翻訳、並進", definition_en: "ある形から別の形に変わること。例：ある言語から別の言語への変換" } },
             { front: { word: "membrane" }, back: { pronunciation: "ˈmɛm.breɪn", definition_jp: "膜", definition_en: "薄い組織のカバー" } },
             { front: { word: "neuron" }, back: { pronunciation: "ˈnʊər.ɒn", definition_jp: "ニューロン", definition_en: "神経細胞；神経系の基本的な構成要素" } },
             { front: { word: "simulation" }, back: { pronunciation: "ˌsɪm.jəˈleɪ.ʃən", definition_jp: "シミュレーション", definition_en: "コピー；実世界の特性を研究・分析するための方法" } },
             { front: { word: "lexical" }, back: { pronunciation: "ˈlɛk.sɪ.kəl", definition_jp: "語彙的な", definition_en: "言葉に関する" } },
             { front: { word: "regime" }, back: { pronunciation: "rəˈʒim", definition_jp: "体制", definition_en: "管理システム；政府の形態" } },
             { front: { word: "variance" }, back: { pronunciation: "ˈvɛər.i.əns", definition_jp: "差異、分散", definition_en: "差の量；分布の変動性を測る統計値" } },
             { front: { word: "molecule" }, back: { pronunciation: "ˈmɒl.əˌkjul", definition_jp: "分子", definition_en: "化学的に結合した2つ以上の原子" } },
             { front: { word: "marker" }, back: { pronunciation: "ˈmɑr.kər", definition_jp: "標識", definition_en: "認識や識別が容易なもの" } },
             { front: { word: "empirical" }, back: { pronunciation: "ɛmˈpɪr.ɪ.kəl", definition_jp: "経験的な", definition_en: "観察や実験に基づく" } },
             { front: { word: "robot" }, back: { pronunciation: "ˈroʊ.bɒt", definition_jp: "ロボット", definition_en: "人間のように行動する機械的な生き物" } },
             { front: { word: "statistical" }, back: { pronunciation: "stəˈtɪs.tɪ.kəl", definition_jp: "統計的な", definition_en: "情報を表す数字に関する" } },
             { front: { word: "vowel" }, back: { pronunciation: "ˈvaʊ.əl", definition_jp: "母音", definition_en: "音声；a、e、i、o、u、時にはyも含む" } },
             { front: { word: "equilibrium" }, back: { pronunciation: "ˌi.kwəˈlɪb.ri.əm", definition_jp: "平衡", definition_en: "バランスの状態" } },
             { front: { word: "intensity" }, back: { pronunciation: "ɪnˈtɛn.sɪ.ti", definition_jp: "強度", definition_en: "大きなエネルギー、強さ、集中；物理学では：強度＝パワー／単位面積" } },
             { front: { word: "regression" }, back: { pronunciation: "rɪˈgrɛʃ.ən", definition_jp: "回帰", definition_en: "後戻り；統計学では：結果の値を別の変数との相関に基づいて予測することに焦点を当てた相関手続きの一種" } },
             { front: { word: "diagnosis" }, back: { pronunciation: "ˌdaɪ.əgˈnoʊ.sɪs", definition_jp: "診断", definition_en: "検査結果に基づく専門家による決定" } },
             { front: { word: "identification" }, back: { pronunciation: "ɪˌdɛn.tɪ.fɪˈkeɪ.ʃən", definition_jp: "識別、同定", definition_en: "識別された状態；人を識別するもの" } },
             { front: { word: "node" }, back: { pronunciation: "noʊd", definition_jp: "節点", definition_en: "ネットワーク内の交差点や接合点；植物で新しい葉が生えるところ" } },
             { front: { word: "partial" }, back: { pronunciation: "pɑrʃəl", definition_jp: "部分的な", definition_en: "不完全；一方の側を他方より好む" } },
             { front: { word: "correlate" }, back: { pronunciation: "ˈkɔr.əˌleɪt", definition_jp: "相関する", definition_en: "2つのアイテムまたはイベント間の関係を示す" } },
             { front: { word: "mortality" }, back: { pronunciation: "mɔrˈtæl.ɪ.ti", definition_jp: "死亡率", definition_en: "人間であり死ぬことができる性質や状態" } },
             { front: { word: "antibody" }, back: { pronunciation: "ˈæn.tɪˌbɒd.i", definition_jp: "抗体", definition_en: "病気に対する体が提供する防御" } },
             { front: { word: "temporal" }, back: { pronunciation: "ˈtɛm.pər.əl", definition_jp: "時間の、側頭部の", definition_en: "時間に関する" } },
             { front: { word: "particle" }, back: { pronunciation: "ˈpɑr.tɪ.kəl", definition_jp: "粒子", definition_en: "非常に小さな何かの一部" } },
             { front: { word: "duration" }, back: { pronunciation: "dʊˈreɪ.ʃən", definition_jp: "持続時間", definition_en: "あるものが続く時間の長さ" } },
             { front: { word: "behavioral" }, back: { pronunciation: "bɪˈheɪv.jər.əl", definition_jp: "行動の", definition_en: "行動の仕方に関する" } },
             { front: { word: "consumption" }, back: { pronunciation: "kənsʌmpʃən", definition_jp: "消費、摂取", definition_en: "物事にかけるお金の量；食べたり飲んだりするプロセス" } },
             { front: { word: "bilingual" }, back: { pronunciation: "baɪˈlɪŋ.gwəl", definition_jp: "バイリンガル", definition_en: "2つの言語を話す人" } },
             { front: { word: "sensitivity" }, back: { pronunciation: "ˌsɛn.sɪˈtɪv.ɪ.ti", definition_jp: "感受性", definition_en: "敏感であること；生理学では：生物またはその一部が刺激に反応する能力；電子工学では：ラジオ機器が着信信号に反応する能力" } },
             { front: { word: "similarity" }, back: { pronunciation: "sˌɪməlɛrəti", definition_jp: "類似性", definition_en: "人や物事が同じである程度" } },
             { front: { word: "optimal" }, back: { pronunciation: "ˈɒp.tə.məl", definition_jp: "最適な", definition_en: "最良" } },
             { front: { word: "explicit" }, back: { pronunciation: "ɪkˈsplɪs.ɪt", definition_jp: "明白な", definition_en: "明確な、はっきりと述べられた" } },
             { front: { word: "mutation" }, back: { pronunciation: "mjuˈteɪ.ʃən", definition_jp: "突然変異", definition_en: "変化；遺伝学では：遺伝構造を変える出来事" } },
             { front: { word: "colonial" }, back: { pronunciation: "kəˈloʊ.ni.əl", definition_jp: "植民地の", definition_en: "集団で生活することに関する" } },
             { front: { word: "spectrum" }, back: { pronunciation: "ˈspɛk.trəm", definition_jp: "スペクトル", definition_en: "赤から紫までの色の波長" } },
             { front: { word: "phonological" }, back: { pronunciation: "ˌfoʊn.lˈɒdʒ.ɪ.kəl", definition_jp: "音韻論的な", definition_en: "音に関する" } },
             { front: { word: "nucleus" }, back: { pronunciation: "ˈnu.kli.əs", definition_jp: "核", definition_en: "細胞の制御中心" } },
             { front: { word: "onset" }, back: { pronunciation: "ɑn.sɛt", definition_jp: "開始", definition_en: "始まり" } },
             { front: { word: "integration" }, back: { pronunciation: "ˌɪn.tɪˈgreɪ.ʃən", definition_jp: "統合", definition_en: "物事を全体としてまとめること" } },
             { front: { word: "dominant" }, back: { pronunciation: "ˈdɒm.ə.nənt", definition_jp: "支配的な", definition_en: "最強" } },
             { front: { word: "pathway" }, back: { pronunciation: "ˈpæθˌweɪ", definition_jp: "経路", definition_en: "経路；生化学では：反応の連鎖" } },
             { front: { word: "coordinate" }, back: { pronunciation: "koʊˈɔr.dnˌeɪt", definition_jp: "調整する、座標", definition_en: "何かに秩序と組織をもたらす；（名）数学では：固定図形または線のシステムを参照して点または線の位置を定義するのに役立つ大きさ" } },
             { front: { word: "calculation" }, back: { pronunciation: "kˌælkyəleɪʃən", definition_jp: "計算", definition_en: "合計の答え；計算する行為" } },
             { front: { word: "precede" }, back: { pronunciation: "prɪˈsid", definition_jp: "先行する", definition_en: "先行する" } },
             { front: { word: "subset" }, back: { pronunciation: "ˈsʌbˌsɛt", definition_jp: "部分集合", definition_en: "より大きな集合の一部である小さな集合" } },
             { front: { word: "syntactic" }, back: { pronunciation: "sɪnˈtæk.tɪk", definition_jp: "統語的な", definition_en: "文法的" } },
             { front: { word: "orientation" }, back: { pronunciation: "ˌɔr.i.ənˈteɪ.ʃən", definition_jp: "方向感覚、オリエンテーション", definition_en: "時間、場所、人々を参照して自分の環境内で自分自身を位置づける能力" } },
             { front: { word: "proposition" }, back: { pronunciation: "ˌprɒp.əˈzɪʃ.ən", definition_jp: "命題、提案", definition_en: "アイデア；提案" } },
             { front: { word: "inequality" }, back: { pronunciation: "ˌɪn.ɪˈkwɒl.ɪ.ti", definition_jp: "不平等、不等式", definition_en: "同じではない；数学では：<、>、=、≠、または？を使用して2つの量を比較する文" } },
             { front: { word: "identical" }, back: { pronunciation: "aɪˈdɛn.tɪ.kəl", definition_jp: "同一の", definition_en: "あらゆる面で同じ" } },
             { front: { word: "prevalence" }, back: { pronunciation: "ˈprɛv.ə.ləns", definition_jp: "普及", definition_en: "広く普及している、一般的な" } },
             { front: { word: "differential" }, back: { pronunciation: "ˌdɪf.əˈrɛn.ʃəl", definition_jp: "差", definition_en: "違い；多様性" } },
             { front: { word: "generalize" }, back: { pronunciation: "ˈdʒɛn.ər.əˌlaɪz", definition_jp: "一般化する", definition_en: "事実から共通の考えや結論を導き出す" } },
             { front: { word: "beam" }, back: { pronunciation: "bim", definition_jp: "梁、光線", definition_en: "金属や木の長い部分；光やエネルギーの線" } },
             { front: { word: "pulse" }, back: { pronunciation: "pʌls", definition_jp: "脈拍", definition_en: "心臓の鼓動" } },
             { front: { word: "norm" }, back: { pronunciation: "nɔrm", definition_jp: "基準", definition_en: "パフォーマンスや行動の確立された基準" } },
             { front: { word: "trait" }, back: { pronunciation: "treɪt", definition_jp: "特徴", definition_en: "特徴" } },
             { front: { word: "prediction" }, back: { pronunciation: "prɪˈdɪk.ʃən", definition_jp: "予測", definition_en: "これから起こることの声明" } },
             { front: { word: "correspondence" }, back: { pronunciation: "ˌkɔr.əˈspɒn.dəns", definition_jp: "通信、一致", definition_en: "文章による通信；類似性" } },
             { front: { word: "essentially" }, back: { pronunciation: "ɪˈsɛnʃəlɪ", definition_jp: "本質的に", definition_en: "基本的に、主に" } },
        ];


        // DOM要素の取得（より堅牢に）
        const getElement = (id) => document.getElementById(id);
        const cardContainer = getElement('cardContainer');
        const currentCard = getElement('currentCard');
        const cardFront = getElement('cardFront');
        const cardBack = getElement('cardBack');
        const startButton = getElement('startButton');
        const cardCounter = getElement('cardCounter');
        const speedControl = getElement('speedControl');
        const speed2sButton = getElement('speed2s');
        const speed1sButton = getElement('speed1s');
        const speed0_5sButton = getElement('speed0_5s');
        const controlBox = getElement('controlBox');
        const prevButtonSmall = getElement('prevButtonSmall'); // 戻るボタン取得
        const nextButtonSmall = getElement('nextButtonSmall');
        const pauseButtonSmall = getElement('pauseButtonSmall');
        const backButton = getElement('backButton');
        const categoryGrid = document.querySelector('.category-grid'); // クラスで取得
        const categoryInfo = getElement('categoryInfo');
        const selectedCategoryText = getElement('selectedCategoryText');
        const categoryCards = document.querySelectorAll('.category-card'); // クラスで取得

        // 状態変数
        let currentCardIndex = 0;
        let autoFlipTimer = null;
        let autoNextTimer = null;
        let isPaused = false;
        let flipDelay = 2000; // デフォルト速度を2秒に
        let autoAdvance = true;

        // カードの表面を表示する関数
        function showCardFront(index) {
             if (!cards || index < 0 || index >= cards.length) return; // データチェック
            const card = cards[index];
            if (!cardFront || !cardBack || !cardCounter || !currentCard) return; // 要素チェック

            // ★ 修正: カード表面のHTMLを生成 - 発音記号の位置を調整
            cardFront.innerHTML = `
                <h2>${card.front.word}</h2>
                <span class="pronunciation" style="position: absolute; top: calc(50% + 100px); left: 50%; transform: translate(-50%, -50%); width: 90%; text-align: center; font-size: 0.95rem; color: white; font-weight: 400; line-height: 1.4; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);">${card.back.pronunciation}</span>
            `;

            // カード裏面のHTMLを生成 - 日本語訳(中央)と英語定義(下部)に位置指定スタイルを追加
            let backHTML = `
                 <p class="definition-jp" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; text-align: center; font-size: 1.3rem; color: #FFD700; margin: 0; font-weight: 500; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);">${card.back.definition_jp}</p>
                 <p class="definition-en" style="position: absolute; bottom: 25px; left: 50%; transform: translateX(-50%); width: 90%; text-align: center; font-size: 0.95rem; color: white; font-weight: 400; line-height: 1.4; text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7); margin: 0;">${card.back.definition_en}</p>
            `;
            cardBack.innerHTML = backHTML;

            // カード番号の更新 (Rank表示) - ゼロパディング & 等幅フォント指定
            cardCounter.innerHTML = `<span style="margin-right: 5px;">Rank</span><span id="rank-value-span" style="font-family: 'Roboto Mono', monospace; min-width: 40px; display: inline-block; text-align: right;">${(index + 1).toString().padStart(3, '0')}</span><span> / ${cards.length}</span>`;


            // カード裏面を確実に非表示にする
            if (cardBack) cardBack.style.display = 'none';

            // カードを表面に戻す（アニメーションのため）
            currentCard.classList.remove('flipped');
            // ちらつき防止のため、クラス削除後に強制リフロー
            void currentCard.offsetHeight;


            // 一時停止中ならクリック可能表示、そうでなければ解除
             if (currentCard) {
                 if (isPaused) {
                     currentCard.classList.add('clickable');
                 } else {
                     currentCard.classList.remove('clickable');
                 }
             }

            // 自動進行が有効かつ一時停止中でない場合、タイマーを設定
            if (autoAdvance && !isPaused) {
                clearTimeout(autoFlipTimer);
                clearTimeout(autoNextTimer);

                autoFlipTimer = setTimeout(() => {
                    if (!isPaused && currentCard && cardBack) {
                        // flipする直前に裏面を表示
                        cardBack.style.display = 'block'; // absolute配置なので block でOK
                        currentCard.classList.add('flipped');
                        autoNextTimer = setTimeout(nextCard, flipDelay);
                    }
                }, flipDelay);
            }
        }

        // 次のカードに進む関数
        function nextCard() {
            clearTimeout(autoFlipTimer);
            clearTimeout(autoNextTimer);
            currentCardIndex = (currentCardIndex + 1) % cards.length;
            showCardFront(currentCardIndex);
        }

        // 前のカードに進む関数
        function prevCard() {
            isPaused = true; // Pause on manual navigation
            if (pauseButtonSmall) {
                pauseButtonSmall.textContent = '再生';
                pauseButtonSmall.classList.add('resume');
            }
            if (currentCard) currentCard.classList.add('clickable');
            clearTimeout(autoFlipTimer);
            clearTimeout(autoNextTimer);

            currentCardIndex--;
            if (currentCardIndex < 0) {
                currentCardIndex = cards.length - 1; // Wrap around to the last card
            }
            showCardFront(currentCardIndex);
        }


        // 表示速度を設定する関数
        function setSpeed(seconds) {
            flipDelay = seconds * 1000; // ミリ秒に変換

            // アクティブなボタンのスタイルを更新
            [speed2sButton, speed1sButton, speed0_5sButton].forEach(btn => {
                if(btn) btn.classList.remove('active');
            });

            let activeButton;
            if (seconds === 2) activeButton = speed2sButton;
            else if (seconds === 1) activeButton = speed1sButton;
            else if (seconds === 0.5) activeButton = speed0_5sButton;

            if(activeButton) activeButton.classList.add('active');

            // 速度変更時にタイマーをリセット（一時停止中でない場合）
            if (!isPaused) {
                clearTimeout(autoFlipTimer);
                clearTimeout(autoNextTimer);
                // 現在のカード表示から再開（新しい速度でタイマーが再設定される）
                showCardFront(currentCardIndex);
            }
        }


        // UI表示切り替え関数
        function showFlashcardView(show) {
             const displayGrid = show ? 'none' : 'grid';
             const displayApp = show ? 'block' : 'none'; // カードコンテナなどは block
             const displayFlexApp = show ? 'flex' : 'none'; // コントロールパネルは flex

             if (categoryGrid) categoryGrid.style.display = displayGrid;
             if (categoryInfo) categoryInfo.style.display = show ? 'none' : 'block';
             if (startButton) startButton.classList.toggle('hidden', show);

             if (cardContainer) cardContainer.classList.toggle('hidden', !show);
             // カードカウンターの表示も制御
             if (cardCounter) cardCounter.style.display = show ? 'inline-block' : 'none'; // blockではなくinline-blockに
             if (controlBox) controlBox.style.display = displayFlexApp; // flexに変更
             if (speedControl) speedControl.style.display = displayFlexApp; // flexに変更
             if (backButton) backButton.style.display = show ? 'inline-block' : 'none';
        }


        // スタートボタンのイベントリスナー
        if (startButton) {
            startButton.addEventListener('click', () => {
                showFlashcardView(true); // フラッシュカード表示

                // 最初のカードを表示して開始
                currentCardIndex = 0;
                isPaused = false;
                if (pauseButtonSmall) {
                    pauseButtonSmall.textContent = '停止'; // 初期テキストを「停止」に
                    pauseButtonSmall.classList.remove('resume'); // resumeクラス削除
                }
                setSpeed(flipDelay / 1000); // 現在の速度設定で開始
                showCardFront(currentCardIndex);

                // カードクリックイベントリスナーを追加
                if (currentCard) {
                    currentCard.removeEventListener('click', handleCardClick); // 念のため削除
                    currentCard.addEventListener('click', handleCardClick);
                }
            });
        }

        // 戻るボタンのイベントリスナー
        if (backButton) {
            backButton.addEventListener('click', () => {
                showFlashcardView(false); // カテゴリ選択表示

                // タイマーを停止・クリア
                clearTimeout(autoFlipTimer);
                clearTimeout(autoNextTimer);
                isPaused = true;

                // カードクリックイベントリスナーを削除
                if (currentCard) {
                    currentCard.removeEventListener('click', handleCardClick);
                }
            });
        }

        // カードクリック処理関数 (手動フリップ)
        function handleCardClick() {
            if (isPaused && currentCard && cardBack) {
                // めくる前に表示状態をトグル
                if (currentCard.classList.contains('flipped')) {
                    // 表面に戻す場合 -> アニメーション後に非表示
                    currentCard.classList.remove('flipped');
                    // アニメーション時間(0.5s)後に非表示にする
                    setTimeout(() => {
                         if (cardBack) cardBack.style.display = 'none';
                    }, 500);
                } else {
                    // 裏面にする場合 -> 表示してからめくる
                    cardBack.style.display = 'block'; // absolute配置なので block でOK
                    currentCard.classList.add('flipped');
                }
            }
        }

        // 前のカードに進む関数
        if (prevButtonSmall) {
            prevButtonSmall.addEventListener('click', prevCard);
        }

        // 次へボタン（小）のイベントリスナー
        if (nextButtonSmall) {
            nextButtonSmall.addEventListener('click', () => {
                 isPaused = true; // 手動操作後は一時停止
                 if (pauseButtonSmall) {
                     pauseButtonSmall.textContent = '再生'; // テキストを「再生」に
                     pauseButtonSmall.classList.add('resume'); // resumeクラス追加
                 }
                 if (currentCard) currentCard.classList.add('clickable');
                 clearTimeout(autoFlipTimer);
                 clearTimeout(autoNextTimer);
                 nextCard();
            });
        }

        // 停止/再生ボタン（小）のイベントリスナー
        if (pauseButtonSmall) {
            pauseButtonSmall.addEventListener('click', () => {
                isPaused = !isPaused;

                if (isPaused) {
                    // 停止処理
                    clearTimeout(autoFlipTimer);
                    clearTimeout(autoNextTimer);
                    pauseButtonSmall.textContent = '再生'; // テキストを「再生」に
                    pauseButtonSmall.classList.add('resume'); // resumeクラス追加
                    if (currentCard) currentCard.classList.add('clickable');
                } else {
                    // 再生処理
                    pauseButtonSmall.textContent = '停止'; // テキストを「停止」に
                    pauseButtonSmall.classList.remove('resume'); // resumeクラス削除
                    if (currentCard) currentCard.classList.remove('clickable');
                    // 現在のカードの状態からタイマーを再開
                    // 裏面が表示されている状態から再開する場合も考慮
                    if (currentCard && currentCard.classList.contains('flipped')) {
                         // 裏面表示中なら、次のカードへのタイマーのみ設定
                         autoNextTimer = setTimeout(nextCard, flipDelay);
                    } else {
                         // 表面表示中なら、通常のタイマー設定
                         showCardFront(currentCardIndex);
                    }
                }
            });
        }

        // 速度ボタンのイベントリスナー
        if (speed2sButton) speed2sButton.addEventListener('click', () => setSpeed(2));
        if (speed1sButton) speed1sButton.addEventListener('click', () => setSpeed(1));
        if (speed0_5sButton) speed0_5sButton.addEventListener('click', () => setSpeed(0.5));


        // カテゴリカードのクリックイベント
        categoryCards.forEach(card => {
             if (!card) return;
            card.addEventListener('click', () => {
                categoryCards.forEach(c => {
                    if(c) c.classList.remove('active');
                });
                 card.classList.add('active');

                 // 選択中カテゴリテキストを更新
                 const categoryName = card.querySelector('h3')?.textContent || '';
                 const rankInfo = card.querySelector('p')?.textContent || '';
                 if(selectedCategoryText) selectedCategoryText.textContent = `${categoryName} (${rankInfo})`;

                 // TODO: カテゴリに応じたデータ読み込み処理
            });
        });

    </script>
</body>
</html>
